workflows:
  element-ios-native:
    name: Element iOS Native Build
    environment:
      groups:
        - ios_signing_credentials
      vars:
        XCODE_VERSION: "15.0"
        BUNDLE_ID: "io.element.elementX"
        BUILD_NUMBER: "1.11.25"

    scripts:
      - name: Install Dependencies
        script: |
          echo "安装 CocoaPods..."
          gem install cocoapods -v 1.16.2
          pod install --repo-update --project-directory=.

      - name: iOS Build
        script: |
          # 初始化钥匙串
          keychain initialize
          
          # 应用签名配置
          xcode-project use-profiles
          
          # 设置构建号
          cd Riot
          agvtool new-version -all $BUILD_NUMBER
          cd ..
          
          # 构建 IPA
          xcodebuild \
            -workspace "Riot.xcworkspace" \
            -scheme "Riot" \
            -configuration Release \
            -archivePath build/Riot.xcarchive \
            archive
          
          # 导出 IPA
          xcodebuild \
            -exportArchive \
            -archivePath build/Riot.xcarchive \
            -exportOptionsPlist "Riot/ExportOptions.plist" \
            -exportPath build/ios/ipa

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      email:
        recipients:
          - your-team@example.com
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
